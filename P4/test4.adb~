-- LORENA BAJO REBOLLO

with Ada.Text_IO;
with Ada.Strings.Unbounded;
with Ada.Exceptions;
with Ada.IO_Exceptions;
with Ada.Command_Line;
with Maps_g;
with Lower_Layer_UDP;
with Ada.Calendar;
with Time_String;
with Gnat.Calendar.Time_IO;

procedure Test4 is

	package ASU renames Ada.Strings.Unbounded;
	package ATI renames Ada.Text_IO;
	package ACL renames Ada.Command_Line;
	package LLU renames Lower_Layer_UDP;
	package C_IO renames Gnat.Calendar.Time_IO;



   function Image_3 (T: Ada.Calendar.Time) return String is
   begin
      return C_IO.Image(T, "%T.%i");
   end Image_3;
   

	package Vecinos is new Maps_G (LLU.End_Point_Type, 
					Ada.Calendar.Time,
 					null,
 					Ada.Calendar.Time_of(2000,2,6), 
					5,
					LLU."=", 
					LLU.Image, 
					Image_3);

	use type ASU.Unbounded_String;
	Use type LLU.End_Point_Type;

	Lista: Vecinos.Map;
	Cond: Boolean;
	EP:LLU.End_Point_Type;
	EP1:LLU.End_Point_Type;
	Hora:Ada.Calendar.Time;
	Claves:Vecinos.Keys_Array_Type;

function EP_Image (EP:LLU.End_Point_Type) return String is
		
		
		use type ASU.Unbounded_String;
		use type LLU.End_Point_Type;

		Usuario: ASU.Unbounded_String;
		IP: ASU.Unbounded_String;
		Puerto: ASU.Unbounded_String;
		Indice:Natural;	
		Dir: ASU.Unbounded_String;	
		Dir_IP: ASU.Unbounded_String;	
		Long_Dir: Natural;
		
	begin
		

			Dir:= ASU.To_Unbounded_String(LLU.Image(EP));
			Long_Dir:= ASU.Length(Dir);
			Indice:= ASU.Index(Dir, ": ");
			Dir_IP:= ASU.Tail(Dir, Long_Dir-Indice);
			Indice:= ASU.Index(Dir_IP, ",");
			IP:= ASU.Head(Dir_IP, Indice-1);
			Indice:= ASU.Index(Dir, "Port: ");
			Puerto:=ASU.Tail(Dir, Long_Dir-Indice-4);
			Usuario := IP & ":" & Puerto;
			
		

		return ASU.To_String(Usuario);

	end EP_Image;





begin

	EP1:=LLU.Build("127.0.0.1", 6001);
	Hora:=Ada.Calendar.Clock;

	Vecinos.Put(Lista, EP1, Hora, Cond);
  	Vecinos.Put(Lista, LLU.Build("17.1.2.38", 9567), Hora, Cond);
	Vecinos.Put(Lista, LLU.Build("17.17.2.38", 9567), Hora, Cond);
	Vecinos.Put(Lista, LLU.Build("17.14.26.38", 9567), Hora, Cond);
	
	Vecinos.Delete(Lista, LLU.Build("17.17.2.38", 9567), Cond);

	Vecinos.Get(Lista, LLU.Build("17.14.26.38", 9567), Hora, Cond);
	Vecinos.Print_Map(Lista);
	Claves:=Vecinos.Get_Keys(Lista);
	--ATI.Put_Line(ASU.To_String(ASU.To_Unbounded_String(Claves)));

	Ada.Text_IO.Put_Line("Mostrando hora con Gnat.Calendar.Time_IO: : " & 
			  Image_3(Hora));
--	LLU.Image(EP);
	ATI.Put_Line(EP_Image(EP1));
	--EP:=ASU.To_Unbounded_String(EP_Image(EP1));
  LLU.Finalize;
end Test4;

